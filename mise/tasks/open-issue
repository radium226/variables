#!/usr/bin/env -S uv run --script
# /// script
# dependencies = []
# ///
import re
import subprocess
import sys


def slugify(text):
    """Convert text to a slug suitable for branch names."""
    text = text.lower()
    text = re.sub(r'[^a-z0-9]+', '-', text)
    text = re.sub(r'-+', '-', text)
    return text.strip('-')


def main():
    if len(sys.argv) < 2:
        print("Usage: mise run open-issue 'Issue title'")
        sys.exit(1)

    title = sys.argv[1]
    tracker = "~radium226/variables"

    # Create the issue using hut
    print(f"Creating issue: {title}")
    try:
        result = subprocess.run(
            ["hut", "todo", "create", "--tracker", tracker, "--title", title],
            capture_output=True,
            text=True,
            check=True
        )
        issue_output = result.stdout
    except subprocess.CalledProcessError as e:
        print(f"Failed to create issue: {e}")
        sys.exit(1)

    # Extract issue number from output
    match = re.search(r'#(\d+)', issue_output)
    if not match:
        print("Failed to extract issue number")
        sys.exit(1)

    issue_num = match.group(1)
    print(f"Created issue #{issue_num}")

    # Create branch name (format: issue-number-slugified-title)
    branch_name = f"issue-{issue_num}-{slugify(title)}"

    # Checkout to new branch
    try:
        subprocess.run(["git", "checkout", "-b", branch_name], check=True)
        print(f"Checked out to branch: {branch_name}")
    except subprocess.CalledProcessError as e:
        print(f"Failed to create branch: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
